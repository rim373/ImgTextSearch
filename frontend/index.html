<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Image & Text Search</title>
  <style>
    *{margin:0;padding:0;box-sizing:border-box}
    body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,sans-serif;background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);min-height:100vh;padding:20px;display:flex;flex-direction:column;align-items:center}
    .container{max-width:1200px;width:100%}
    header{text-align:center;color:#fff;margin-bottom:30px}
    h1{font-size:2.5rem;font-weight:700;margin-bottom:10px}
    .subtitle{font-size:1.1rem;opacity:.9}
    .search-card{background:#fff;border-radius:20px;padding:30px;box-shadow:0 20px 60px rgba(0,0,0,.3);margin-bottom:30px}
    .mode-toggle{display:flex;gap:15px;justify-content:center;margin-bottom:25px}
    .mode-btn{flex:1;max-width:200px;padding:12px 25px;border:2px solid #e0e0e0;background:#fff;border-radius:12px;cursor:pointer;transition:all .2s;font-size:1rem;font-weight:600;color:#666}
    .mode-btn:hover{border-color:#667eea;color:#667eea}
    .mode-btn.active{background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);color:#fff;border-color:transparent}
    .search-section{display:none}
    .search-section.active{display:block}
    .drop-zone{border:3px dashed #667eea;border-radius:16px;padding:50px 20px;text-align:center;background:#f8f9ff;cursor:pointer;transition:all .2s}
    .drop-zone:hover,.drop-zone.drag-over{background:#eef1ff;border-color:#764ba2}
    .drop-zone-icon{font-size:3rem;margin-bottom:10px}
    .drop-zone-text{font-size:1.1rem;color:#666;margin-bottom:8px}
    .drop-zone-hint{font-size:.9rem;color:#999}
    #fileInput{display:none}
    #preview{margin-top:15px;text-align:center}
    #preview img{max-width:100%;max-height:250px;border-radius:12px}
    .clear-btn{margin-top:10px;padding:8px 20px;background:#ff4757;color:#fff;border:none;border-radius:8px;cursor:pointer;font-size:.9rem}
    #textInput{width:100%;padding:18px;border:2px solid #e0e0e0;border-radius:12px;font-size:1rem;font-family:inherit;resize:vertical;min-height:100px}
    #textInput:focus{outline:none;border-color:#667eea}
    .topk-wrapper{margin-top:15px;display:flex;align-items:center;justify-content:center;gap:10px}
    .topk-wrapper label{font-weight:600;color:#666}
    #topKInput{width:70px;padding:8px;border:2px solid #e0e0e0;border-radius:8px;font-size:1rem;text-align:center}
    .search-btn{width:100%;padding:15px;margin-top:20px;background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);color:#fff;border:none;border-radius:12px;font-size:1.1rem;font-weight:600;cursor:pointer;transition:all .2s}
    .search-btn:hover{transform:translateY(-2px)}
    .search-btn:disabled{background:#ccc;cursor:not-allowed;transform:none}
    .spinner{display:none;text-align:center;margin:25px 0}
    .spinner.active{display:block}
    .spinner-icon{width:40px;height:40px;border:4px solid rgba(255,255,255,.3);border-top-color:#fff;border-radius:50%;animation:spin 1s linear infinite;margin:0 auto}
    @keyframes spin{to{transform:rotate(360deg)}}
    .spinner-text{color:#fff;margin-top:10px;font-size:1rem}
    .results-container{margin-top:30px}
    .results-header{text-align:center;color:#fff;margin-bottom:20px}
    .results-header h2{font-size:1.6rem;margin-bottom:8px}
    .results-count{font-size:1rem;opacity:.9}
    #results{display:grid;grid-template-columns:repeat(auto-fill,minmax(180px,1fr));gap:20px}
    .result-card{background:#fff;border-radius:14px;overflow:hidden;cursor:pointer;transition:transform .2s}
    .result-card:hover{transform:translateY(-5px)}
    .result-card img{width:100%;height:180px;object-fit:cover;display:block}
    .result-info{padding:10px;text-align:center}
    .result-score{font-size:.85rem;color:#667eea;font-weight:600}
    .no-results{text-align:center;color:#fff;font-size:1.1rem;padding:30px;background:rgba(255,255,255,.1);border-radius:16px}
    .modal{display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,.9);z-index:1000;justify-content:center;align-items:center}
    .modal.active{display:flex}
    .modal img{max-width:90%;max-height:90%;border-radius:8px}
    .modal-close{position:absolute;top:15px;right:25px;color:#fff;font-size:2.5rem;cursor:pointer;z-index:1001}
  </style>
</head>
<body>
  <div class="container">
    <header>
      <h1>üîç Smart Search</h1>
      <p class="subtitle">Search by image or text with AI-powered similarity</p>
    </header>

    <div class="search-card">
      <div class="mode-toggle">
        <button class="mode-btn active" data-mode="image">üñºÔ∏è Image</button>
        <button class="mode-btn" data-mode="text">üìù Text</button>
      </div>

      <div class="search-section active" id="imageSection">
        <div class="drop-zone" id="dropZone">
          <div class="drop-zone-icon">üì§</div>
          <div class="drop-zone-text">Drop image or click to browse</div>
          <div class="drop-zone-hint">JPG, PNG, GIF</div>
        </div>
        <input type="file" id="fileInput" accept="image/*" />
        <div id="preview"></div>
      </div>

      <div class="search-section" id="textSection">
        <textarea id="textInput" placeholder="Enter your search query...&#10;e.g., 'red car', 'sunset mountains'"></textarea>
      </div>

      <button class="search-btn" id="searchBtn">üîç Search</button>
    </div>

    <div class="spinner" id="spinner">
      <div class="spinner-icon"></div>
      <div class="spinner-text">Searching...</div>
    </div>

    <div class="results-container" id="resultsContainer" style="display:none">
      <div class="results-header">
        <h2>Results</h2>
        <p class="results-count" id="resultsCount"></p>
      </div>
      <div id="results"></div>
    </div>
  </div>

  <div class="modal" id="modal">
    <span class="modal-close" id="modalClose">&times;</span>
    <img id="modalImg" src="" alt="Full view">
  </div>

  <script>
    const API = "http://localhost:8000";
    const $ = (s) => document.querySelector(s);
    const $$ = (s) => document.querySelectorAll(s);
    
    const els = {
      modeBtns: $$('.mode-btn'),
      imageSection: $('#imageSection'),
      textSection: $('#textSection'),
      dropZone: $('#dropZone'),
      fileInput: $('#fileInput'),
      preview: $('#preview'),
      textInput: $('#textInput'),
      topKInput: $('#topKInput'),
      searchBtn: $('#searchBtn'),
      spinner: $('#spinner'),
      resultsContainer: $('#resultsContainer'),
      results: $('#results'),
      resultsCount: $('#resultsCount'),
      modal: $('#modal'),
      modalImg: $('#modalImg'),
      modalClose: $('#modalClose')
    };

    let selectedFile = null;
    let currentMode = 'image';
    let abortController = null;

    // Mode Toggle
    els.modeBtns.forEach(btn => {
      btn.onclick = () => {
        els.modeBtns.forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        currentMode = btn.dataset.mode;
        
        if (currentMode === 'image') {
          els.imageSection.classList.add('active');
          els.textSection.classList.remove('active');
        } else {
          els.textSection.classList.add('active');
          els.imageSection.classList.remove('active');
        }
      };
    });

    // Drop Zone
    els.dropZone.onclick = () => els.fileInput.click();
    els.dropZone.ondragover = (e) => {
      e.preventDefault();
      els.dropZone.classList.add('drag-over');
    };
    els.dropZone.ondragleave = () => els.dropZone.classList.remove('drag-over');
    els.dropZone.ondrop = (e) => {
      e.preventDefault();
      els.dropZone.classList.remove('drag-over');
      const file = e.dataTransfer.files[0];
      if (file?.type.startsWith('image/')) handleFile(file);
    };

    els.fileInput.onchange = (e) => {
      const file = e.target.files[0];
      if (file) handleFile(file);
    };

    const handleFile = (file) => {
      selectedFile = file;
      const reader = new FileReader();
      reader.onload = () => {
        els.preview.innerHTML = `<img src="${reader.result}" alt="preview"><br><button class="clear-btn" onclick="clearImage()">‚úï Clear</button>`;
      };
      reader.readAsDataURL(file);
    };

    window.clearImage = () => {
      selectedFile = null;
      els.preview.innerHTML = '';
      els.fileInput.value = '';
    };

    // Search
    els.searchBtn.onclick = async () => {
      // Cancel previous request
      if (abortController) abortController.abort();
      abortController = new AbortController();

      els.results.innerHTML = '';
      els.resultsContainer.style.display = 'none';
      els.spinner.classList.add('active');
      els.searchBtn.disabled = true;

      try {
        const topK = parseInt(els.topKInput.value) || 10;
        const formData = new FormData();
        formData.append("top_k", topK);

        let endpoint;
        if (currentMode === 'image') {
          if (!selectedFile) {
            alert('‚ö†Ô∏è Please select an image!');
            return;
          }
          formData.append("file", selectedFile);
          endpoint = '/search/image';
        } else {
          const text = els.textInput.value.trim();
          if (!text) {
            alert('‚ö†Ô∏è Please enter a query!');
            return;
          }
          formData.append("query_text", text);
          endpoint = '/search/text';
        }

        const res = await fetch(API + endpoint, { 
          method: "POST", 
          body: formData,
          signal: abortController.signal
        });

        const data = await res.json();

        if (!data.results?.length) {
          els.resultsContainer.style.display = 'block';
          els.results.innerHTML = '<div class="no-results">No results found!</div>';
          return;
        }

        els.resultsContainer.style.display = 'block';
        els.resultsCount.textContent = `Found ${data.results.length} images`;

        // Batch DOM updates
        const fragment = document.createDocumentFragment();
        data.results.forEach((r, i) => {
          const card = document.createElement('div');
          card.className = 'result-card';
          const imgSrc = API + "/images/" + r.path;
          card.innerHTML = `<img src="${imgSrc}" alt="r${i}" loading="lazy"><div class="result-info"><div class="result-score">#${i + 1}</div></div>`;
          card.onclick = () => {
            els.modalImg.src = imgSrc;
            els.modal.classList.add('active');
          };
          fragment.appendChild(card);
        });
        els.results.appendChild(fragment);

      } catch (err) {
        if (err.name !== 'AbortError') {
          alert('‚ùå Error: ' + err.message);
        }
      } finally {
        els.spinner.classList.remove('active');
        els.searchBtn.disabled = false;
      }
    };

    // Modal
    els.modalClose.onclick = () => els.modal.classList.remove('active');
    els.modal.onclick = (e) => {
      if (e.target === els.modal) els.modal.classList.remove('active');
    };

    // Keyboard shortcuts
    els.textInput.onkeydown = (e) => {
      if (e.ctrlKey && e.key === 'Enter') els.searchBtn.click();
    };
  </script>
</body>
</html>